<!DOCTYPE html>
<html>  
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">
    <title>
      你好，世界_网魂的博客
    </title>
    <!-- Bootstrap Core CSS -->
    <link href="/css/bootstrap.min.css" rel="stylesheet">
    <!-- Custom CSS -->
    <link href="/css/blog.css" rel="stylesheet">
    <!-- Custom CSS -->
    <link href="/css/pygments.css" rel="stylesheet">
    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media
    queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file://
    -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js">
      </script>
      <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js">
      </script>
    <![endif]-->
  </head>  
  <body>
    <!-- Navigation -->
    <nav class="navbar navbar-inverse navbar-fixed-top" role="navigation">
      <div class="container">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header">
          <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
            <span class="sr-only">
              Toggle navigation
            </span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="/">网魂的博客</a>
        </div>
        <!-- Collect the nav links, forms, and other content for toggling -->
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
          <ul class="nav navbar-nav">
            <li>
              <a href="/archives.html">
                归 档
              </a>
            </li>
            <li>
              <a href="/categories.html">
                分 类
              </a>
            </li>
            <li>
              <a href="/atom.xml">
                RSS
              </a>
            </li>
          </ul>
        </div>
        <!-- /.navbar-collapse -->
      </div>
      <!-- /.container -->
    </nav>
    <!-- Page Content -->
    <div class="container">
      <div class="row">
        <!-- Blog Entries Column -->
        <div class="col-md-8">
          <!-- Blog Post -->
<!-- Title -->
<h2>
  你好，世界
  <div class="post-date">
	<span class="glyphicon glyphicon-time"></span>
	2014-09-22
  </div>
</h2>
<!-- Author -->
<hr>
<h3>高亮Python</h3>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="lineno">1</span> <span class="nd">@requires_authorization</span>
<span class="lineno">2</span> <span class="k">class</span> <span class="nc">SomeClass</span><span class="p">:</span>
<span class="lineno">3</span>     <span class="k">pass</span>
<span class="lineno">4</span> 
<span class="lineno">5</span> <span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
<span class="lineno">6</span>     <span class="c"># A comment</span>
<span class="lineno">7</span>     <span class="k">print</span> <span class="s">&#39;hello world&#39;</span></code></pre></div>

<h3>高亮C</h3>

<div class="highlight"><pre><code class="language-c#" data-lang="c#"><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Collections</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Collections.Generic</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Diagnostics</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.IO</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Runtime.InteropServices</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.ServiceModel</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Text</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Threading</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Windows</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Windows.Media.Imaging</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Entity</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Hardcodet.Wpf.TaskbarNotification</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">InternalServiceManager.Interface</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">InternalServiceManager.Service</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">InternalServiceManager.Service.BAL</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Microsoft.Win32</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">ZQTConsole.AppCode</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">ZQTConsole.View</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">ZQTConsole.ViewModel</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.ServiceProcess</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">ZQTConsole</span>
<span class="p">{</span>
    <span class="c1">/// &lt;summary&gt;</span>
    <span class="c1">/// App.xaml 的交互逻辑</span>
    <span class="c1">/// &lt;/summary&gt;</span>
    <span class="k">public</span> <span class="k">partial</span> <span class="k">class</span> <span class="nc">App</span> <span class="p">:</span> <span class="n">Application</span>
    <span class="p">{</span>
        <span class="cp">#region 私有变量</span>
        <span class="k">private</span> <span class="n">Mutex</span> <span class="n">mutex</span><span class="p">;</span>
        <span class="k">private</span> <span class="n">ServiceHost</span> <span class="n">host</span><span class="p">;</span>
        <span class="k">private</span> <span class="n">Timer</span> <span class="n">informationTimer</span><span class="p">;</span>
        <span class="k">private</span> <span class="n">Timer</span> <span class="n">newsTimer</span><span class="p">;</span>
        <span class="c1">//private Timer updateUserTimer;</span>
        <span class="k">private</span> <span class="n">Timer</span> <span class="n">csMsgTimer</span><span class="p">;</span>
        <span class="k">private</span> <span class="n">Timer</span> <span class="n">updateServiceCheckTimer</span><span class="p">;</span>
        <span class="k">private</span> <span class="n">TaskbarIcon</span> <span class="n">taskbarIcon</span><span class="p">;</span>
        <span class="cp">#endregion</span>

        <span class="k">public</span> <span class="nf">App</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="kt">bool</span> <span class="n">flag</span><span class="p">;</span>
            <span class="n">mutex</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Mutex</span><span class="p">(</span><span class="k">true</span><span class="p">,</span> <span class="n">Constant</span><span class="p">.</span><span class="n">MUTEX_NAME_ZQTSERVICE</span><span class="p">,</span> <span class="k">out</span> <span class="n">flag</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(!</span><span class="n">flag</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">Environment</span><span class="p">.</span><span class="n">Exit</span><span class="p">(-</span><span class="m">1</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="n">Directory</span><span class="p">.</span><span class="n">SetCurrentDirectory</span><span class="p">(</span><span class="n">AppDomain</span><span class="p">.</span><span class="n">CurrentDomain</span><span class="p">.</span><span class="n">BaseDirectory</span><span class="p">);</span>
            <span class="n">InitializeComponent</span><span class="p">();</span>
        <span class="p">}</span>

        <span class="cp">#region 目录监视事件</span>

        <span class="k">private</span> <span class="k">void</span> <span class="nf">SetupApp</span><span class="p">(</span><span class="kt">string</span> <span class="n">path</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">try</span>
            <span class="p">{</span>
                <span class="n">ProductMenifest</span> <span class="n">menifest</span> <span class="p">=</span> <span class="n">ProductMenifest</span><span class="p">.</span><span class="n">Deserialize</span><span class="p">(</span><span class="n">path</span><span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">menifest</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="k">return</span><span class="p">;</span>
                <span class="p">}</span>

                <span class="n">InstalledApp</span> <span class="n">app</span> <span class="p">=</span> <span class="k">new</span> <span class="n">InstalledApp</span><span class="p">();</span>
                <span class="n">app</span><span class="p">.</span><span class="n">AppID</span> <span class="p">=</span> <span class="n">menifest</span><span class="p">.</span><span class="n">ProductID</span><span class="p">;</span>
                <span class="n">app</span><span class="p">.</span><span class="n">Name</span> <span class="p">=</span> <span class="n">menifest</span><span class="p">.</span><span class="n">ProductTag</span><span class="p">;</span>
                <span class="n">app</span><span class="p">.</span><span class="n">DisplayName</span> <span class="p">=</span> <span class="n">menifest</span><span class="p">.</span><span class="n">ProductName</span><span class="p">;</span>
                <span class="n">app</span><span class="p">.</span><span class="n">Description</span> <span class="p">=</span> <span class="n">menifest</span><span class="p">.</span><span class="n">Description</span><span class="p">;</span>
                <span class="n">app</span><span class="p">.</span><span class="n">InstallPath</span> <span class="p">=</span> <span class="n">menifest</span><span class="p">.</span><span class="n">UpdateDestDir</span><span class="p">;</span>
                <span class="n">app</span><span class="p">.</span><span class="n">Version</span> <span class="p">=</span> <span class="n">menifest</span><span class="p">.</span><span class="n">CurrentVersion</span><span class="p">;</span>
                <span class="n">app</span><span class="p">.</span><span class="n">PublishDate</span> <span class="p">=</span> <span class="n">menifest</span><span class="p">.</span><span class="n">DT_PublishDate</span><span class="p">;</span>
                <span class="n">app</span><span class="p">.</span><span class="n">Publisher</span> <span class="p">=</span> <span class="n">menifest</span><span class="p">.</span><span class="n">Publisher</span><span class="p">;</span>
                <span class="n">app</span><span class="p">.</span><span class="n">InstallTime</span> <span class="p">=</span> <span class="n">DateTime</span><span class="p">.</span><span class="n">Now</span><span class="p">;</span>

                <span class="n">app</span><span class="p">.</span><span class="n">UpdateTime</span> <span class="p">=</span> <span class="n">GetAppLastUpdateTime</span><span class="p">(</span><span class="n">app</span><span class="p">.</span><span class="n">AppID</span><span class="p">);</span>

                <span class="k">if</span> <span class="p">(</span><span class="n">AppManager</span><span class="p">.</span><span class="n">ExistsInstallApp</span><span class="p">(</span><span class="n">app</span><span class="p">.</span><span class="n">AppID</span><span class="p">))</span>
                <span class="p">{</span>
                    <span class="n">AppManager</span><span class="p">.</span><span class="n">UpdateInstallApp</span><span class="p">(</span><span class="n">app</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="k">else</span>
                <span class="p">{</span>
                    <span class="n">AppManager</span><span class="p">.</span><span class="n">AddInstallApp</span><span class="p">(</span><span class="n">app</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">}</span>
            <span class="k">catch</span> <span class="p">{</span> <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">private</span> <span class="k">void</span> <span class="nf">watcher_Created</span><span class="p">(</span><span class="kt">object</span> <span class="n">sender</span><span class="p">,</span> <span class="n">FileSystemEventArgs</span> <span class="n">e</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">SetupApp</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">FullPath</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">private</span> <span class="k">void</span> <span class="nf">watcher_Changed</span><span class="p">(</span><span class="kt">object</span> <span class="n">sender</span><span class="p">,</span> <span class="n">FileSystemEventArgs</span> <span class="n">e</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">SetupApp</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">FullPath</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="cp">#endregion</span>

        <span class="cp">#region Base service event</span>
        <span class="k">private</span> <span class="k">void</span> <span class="nf">BaseService_CSMessageSync</span><span class="p">(</span><span class="kt">object</span> <span class="n">sender</span><span class="p">,</span> <span class="n">CSMessageSyncArgs</span> <span class="n">e</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">csMsgTimer</span> <span class="p">==</span> <span class="k">null</span> <span class="p">||</span> <span class="n">e</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">return</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">IsImmediate</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">csMsgTimer</span><span class="p">.</span><span class="n">Change</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="m">15000</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">else</span>
            <span class="p">{</span>
                <span class="n">csMsgTimer</span><span class="p">.</span><span class="n">Change</span><span class="p">(</span><span class="m">600000</span><span class="p">,</span> <span class="m">1200000</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">private</span> <span class="k">void</span> <span class="nf">BaseService_NewUserLogin</span><span class="p">(</span><span class="kt">object</span> <span class="n">sender</span><span class="p">,</span> <span class="n">EventArgs</span> <span class="n">e</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">if</span> <span class="p">(!</span><span class="n">NetParamsMananger</span><span class="p">.</span><span class="n">NetParams</span><span class="p">.</span><span class="n">ServerEnabled</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">return</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="k">try</span>
            <span class="p">{</span>
                <span class="k">if</span> <span class="p">(!</span><span class="n">PacketManager</span><span class="p">.</span><span class="n">NetworkTest</span><span class="p">())</span>
                <span class="p">{</span>
                    <span class="k">return</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span>
            <span class="k">catch</span>
            <span class="p">{</span>
                <span class="k">return</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="n">List</span><span class="p">&lt;</span><span class="n">Entity</span><span class="p">.</span><span class="n">User</span><span class="p">&gt;</span> <span class="n">loginedUsers</span> <span class="p">=</span> <span class="n">BaseService</span><span class="p">.</span><span class="n">LoginedUsers</span><span class="p">;</span>
            <span class="k">foreach</span> <span class="p">(</span><span class="n">Entity</span><span class="p">.</span><span class="n">User</span> <span class="n">u</span> <span class="k">in</span> <span class="n">loginedUsers</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">try</span>
                <span class="p">{</span>
                    <span class="n">PacketManager</span><span class="p">.</span><span class="n">SyncInfomation</span><span class="p">(</span><span class="n">BaseService</span><span class="p">.</span><span class="n">QYH</span><span class="p">,</span> <span class="n">u</span><span class="p">.</span><span class="n">UserID</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="k">catch</span> <span class="p">(</span><span class="n">Exception</span> <span class="n">ex</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="n">ExceptionManager</span><span class="p">.</span><span class="n">LogException</span><span class="p">(</span><span class="n">ex</span><span class="p">);</span>
                <span class="p">}</span>

                <span class="c1">//try</span>
                <span class="c1">//{</span>
                <span class="c1">//    PacketManager.GetRecommendApps(u.UserID);</span>
                <span class="c1">//}</span>
                <span class="c1">//catch (Exception ex)</span>
                <span class="c1">//{</span>
                <span class="c1">//    ExceptionManager.LogException(ex);</span>
                <span class="c1">//}</span>
            <span class="p">}</span>

            <span class="n">Thread</span> <span class="n">initialTask</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="p">(()</span> <span class="p">=&gt;</span>
            <span class="p">{</span>
                <span class="k">foreach</span> <span class="p">(</span><span class="n">Entity</span><span class="p">.</span><span class="n">User</span> <span class="n">u</span> <span class="k">in</span> <span class="n">loginedUsers</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="k">try</span>
                    <span class="p">{</span>
                        <span class="n">PacketManager</span><span class="p">.</span><span class="n">DownloadUsers</span><span class="p">(</span><span class="n">u</span><span class="p">.</span><span class="n">QYH</span><span class="p">,</span> <span class="n">u</span><span class="p">.</span><span class="n">UserID</span><span class="p">);</span>
                    <span class="p">}</span>
                    <span class="k">catch</span> <span class="p">(</span><span class="n">Exception</span> <span class="n">ex</span><span class="p">)</span>
                    <span class="p">{</span>
                        <span class="n">ExceptionManager</span><span class="p">.</span><span class="n">LogException</span><span class="p">(</span><span class="n">ex</span><span class="p">);</span>
                    <span class="p">}</span>

                    <span class="k">try</span>
                    <span class="p">{</span>
                        <span class="n">PacketManager</span><span class="p">.</span><span class="n">DownloadAppRoleUsers</span><span class="p">(</span><span class="n">u</span><span class="p">.</span><span class="n">QYH</span><span class="p">,</span> <span class="n">u</span><span class="p">.</span><span class="n">UserID</span><span class="p">);</span>
                    <span class="p">}</span>
                    <span class="k">catch</span> <span class="p">(</span><span class="n">Exception</span> <span class="n">ex</span><span class="p">)</span>
                    <span class="p">{</span>
                        <span class="n">ExceptionManager</span><span class="p">.</span><span class="n">LogException</span><span class="p">(</span><span class="n">ex</span><span class="p">);</span>
                    <span class="p">}</span>

                    <span class="k">try</span>
                    <span class="p">{</span>
                        <span class="n">PacketManager</span><span class="p">.</span><span class="n">SyncServerAddress</span><span class="p">(</span><span class="n">u</span><span class="p">.</span><span class="n">QYH</span><span class="p">,</span> <span class="n">u</span><span class="p">.</span><span class="n">UserID</span><span class="p">);</span>
                    <span class="p">}</span>
                    <span class="k">catch</span> <span class="p">(</span><span class="n">Exception</span> <span class="n">ex</span><span class="p">)</span>
                    <span class="p">{</span>
                        <span class="n">ExceptionManager</span><span class="p">.</span><span class="n">LogException</span><span class="p">(</span><span class="n">ex</span><span class="p">);</span>
                    <span class="p">}</span>

                    <span class="k">try</span>
                    <span class="p">{</span>
                        <span class="n">PacketManager</span><span class="p">.</span><span class="n">DownloadQYZHXX</span><span class="p">(</span><span class="n">u</span><span class="p">.</span><span class="n">QYH</span><span class="p">,</span> <span class="n">u</span><span class="p">.</span><span class="n">UserID</span><span class="p">);</span>
                    <span class="p">}</span>
                    <span class="k">catch</span> <span class="p">(</span><span class="n">Exception</span> <span class="n">ex</span><span class="p">)</span>
                    <span class="p">{</span>
                        <span class="n">ExceptionManager</span><span class="p">.</span><span class="n">LogException</span><span class="p">(</span><span class="n">ex</span><span class="p">);</span>
                    <span class="p">}</span>

                    <span class="k">try</span>
                    <span class="p">{</span>
                        <span class="n">PacketManager</span><span class="p">.</span><span class="n">SyncKFFeedback</span><span class="p">(</span><span class="n">u</span><span class="p">.</span><span class="n">UserID</span><span class="p">);</span>
                    <span class="p">}</span>
                    <span class="k">catch</span> <span class="p">(</span><span class="n">Exception</span> <span class="n">ex</span><span class="p">)</span>
                    <span class="p">{</span>
                        <span class="n">ExceptionManager</span><span class="p">.</span><span class="n">LogException</span><span class="p">(</span><span class="n">ex</span><span class="p">);</span>
                    <span class="p">}</span>

                    <span class="k">try</span>
                    <span class="p">{</span>
                        <span class="n">PacketManager</span><span class="p">.</span><span class="n">UploadUsers</span><span class="p">(</span><span class="n">BaseService</span><span class="p">.</span><span class="n">QYH</span><span class="p">,</span> <span class="n">u</span><span class="p">.</span><span class="n">UserID</span><span class="p">);</span>
                    <span class="p">}</span>
                    <span class="k">catch</span> <span class="p">(</span><span class="n">Exception</span> <span class="n">ex</span><span class="p">)</span>
                    <span class="p">{</span>
                        <span class="n">ExceptionManager</span><span class="p">.</span><span class="n">LogException</span><span class="p">(</span><span class="n">ex</span><span class="p">);</span>
                    <span class="p">}</span>

                    <span class="k">try</span>
                    <span class="p">{</span>
                        <span class="n">PacketManager</span><span class="p">.</span><span class="n">SyncCustomService</span><span class="p">(</span><span class="n">u</span><span class="p">.</span><span class="n">QYH</span><span class="p">,</span> <span class="n">u</span><span class="p">.</span><span class="n">UserID</span><span class="p">);</span>
                    <span class="p">}</span>
                    <span class="k">catch</span> <span class="p">(</span><span class="n">Exception</span> <span class="n">ex</span><span class="p">)</span>
                    <span class="p">{</span>
                        <span class="n">ExceptionManager</span><span class="p">.</span><span class="n">LogException</span><span class="p">(</span><span class="n">ex</span><span class="p">);</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">});</span>
            <span class="n">initialTask</span><span class="p">.</span><span class="n">Priority</span> <span class="p">=</span> <span class="n">ThreadPriority</span><span class="p">.</span><span class="n">Highest</span><span class="p">;</span>
            <span class="n">initialTask</span><span class="p">.</span><span class="n">IsBackground</span> <span class="p">=</span> <span class="k">true</span><span class="p">;</span>
            <span class="n">initialTask</span><span class="p">.</span><span class="n">Start</span><span class="p">();</span>

            <span class="n">informationTimer</span><span class="p">.</span><span class="n">Change</span><span class="p">(</span><span class="m">600000</span><span class="p">,</span> <span class="m">600000</span><span class="p">);</span>
            <span class="n">csMsgTimer</span><span class="p">.</span><span class="n">Change</span><span class="p">(</span><span class="m">180000</span><span class="p">,</span> <span class="m">1200000</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="cp">#endregion</span>

        <span class="k">private</span> <span class="n">DateTime</span> <span class="nf">GetAppLastUpdateTime</span><span class="p">(</span><span class="kt">string</span> <span class="n">appID</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">DateTime</span> <span class="n">lastUpdateTime</span> <span class="p">=</span> <span class="n">DateTime</span><span class="p">.</span><span class="n">Now</span><span class="p">;</span>
            <span class="k">try</span>
            <span class="p">{</span>
                <span class="k">using</span> <span class="p">(</span><span class="n">RegistryKey</span> <span class="n">rklm</span> <span class="p">=</span> <span class="n">Registry</span><span class="p">.</span><span class="n">LocalMachine</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="k">using</span> <span class="p">(</span><span class="n">RegistryKey</span> <span class="n">rkApp</span> <span class="p">=</span> <span class="n">rklm</span><span class="p">.</span><span class="n">OpenSubKey</span><span class="p">(</span><span class="n">Constant</span><span class="p">.</span><span class="n">REGISTRYKEY_PRODUCT_ROOT</span> <span class="p">+</span> <span class="n">appID</span><span class="p">))</span>
                    <span class="p">{</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">rkApp</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>
                        <span class="p">{</span>
                            <span class="n">lastUpdateTime</span> <span class="p">=</span> <span class="n">DateTime</span><span class="p">.</span><span class="n">Parse</span><span class="p">(</span><span class="n">rkApp</span><span class="p">.</span><span class="n">GetValue</span><span class="p">(</span><span class="n">Constant</span><span class="p">.</span><span class="n">REGISTRYKEY_PRODUCT_LASTUPDATETIME</span><span class="p">,</span> <span class="kt">string</span><span class="p">.</span><span class="n">Empty</span><span class="p">).</span><span class="n">ToString</span><span class="p">());</span>
                        <span class="p">}</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span>
            <span class="k">catch</span> <span class="p">{</span> <span class="p">}</span>

            <span class="k">return</span> <span class="n">lastUpdateTime</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="cp">#region 应用程序事件</span>
        <span class="k">private</span> <span class="k">void</span> <span class="nf">Application_Startup</span><span class="p">(</span><span class="kt">object</span> <span class="n">sender</span><span class="p">,</span> <span class="n">StartupEventArgs</span> <span class="n">e</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="kt">string</span> <span class="n">zqtPath</span> <span class="p">=</span> <span class="kt">string</span><span class="p">.</span><span class="n">Empty</span><span class="p">;</span>
            <span class="kt">string</span> <span class="n">addInPath</span> <span class="p">=</span> <span class="kt">string</span><span class="p">.</span><span class="n">Empty</span><span class="p">;</span>

            <span class="n">ResourceDictionary</span> <span class="n">rd</span> <span class="p">=</span> <span class="k">new</span> <span class="n">ResourceDictionary</span>
            <span class="p">{</span>
                <span class="n">Source</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Uri</span><span class="p">(</span><span class="s">&quot;/ZQTConsole;component/Resources/AppRes.xaml&quot;</span><span class="p">,</span> <span class="n">UriKind</span><span class="p">.</span><span class="n">Relative</span><span class="p">)</span>
            <span class="p">};</span>

            <span class="n">taskbarIcon</span> <span class="p">=</span> <span class="k">new</span> <span class="n">TaskbarIcon</span><span class="p">();</span>

            <span class="n">BitmapImage</span> <span class="n">bitmapim</span> <span class="p">=</span> <span class="k">new</span> <span class="n">BitmapImage</span><span class="p">(</span><span class="k">new</span> <span class="n">Uri</span><span class="p">(</span><span class="s">&quot;pack://application:,,,/Images/logo.ico&quot;</span><span class="p">,</span> <span class="n">UriKind</span><span class="p">.</span><span class="n">Absolute</span><span class="p">));</span>
            <span class="n">taskbarIcon</span><span class="p">.</span><span class="n">IconSource</span> <span class="p">=</span> <span class="n">bitmapim</span><span class="p">;</span>

            <span class="n">taskbarIcon</span><span class="p">.</span><span class="n">ContextMenu</span> <span class="p">=</span> <span class="p">(</span><span class="n">System</span><span class="p">.</span><span class="n">Windows</span><span class="p">.</span><span class="n">Controls</span><span class="p">.</span><span class="n">ContextMenu</span><span class="p">)</span><span class="n">rd</span><span class="p">[</span><span class="s">&quot;contextMenu&quot;</span><span class="p">];</span>
            <span class="n">taskbarIcon</span><span class="p">.</span><span class="n">PopupActivation</span> <span class="p">=</span> <span class="n">PopupActivationMode</span><span class="p">.</span><span class="n">All</span><span class="p">;</span>
            <span class="n">taskbarIcon</span><span class="p">.</span><span class="n">MenuActivation</span> <span class="p">=</span> <span class="n">PopupActivationMode</span><span class="p">.</span><span class="n">LeftOrRightClick</span><span class="p">;</span>
            <span class="n">taskbarIcon</span><span class="p">.</span><span class="n">Visibility</span> <span class="p">=</span> <span class="n">Visibility</span><span class="p">.</span><span class="n">Visible</span><span class="p">;</span>
            <span class="n">taskbarIcon</span><span class="p">.</span><span class="n">ToolTipText</span> <span class="p">=</span> <span class="s">&quot;壳牌快速发票系统&quot;</span><span class="p">;</span>
            <span class="n">taskbarIcon</span><span class="p">.</span><span class="n">TrayMouseDoubleClick</span> <span class="p">+=</span> <span class="k">new</span> <span class="n">RoutedEventHandler</span><span class="p">(</span><span class="n">taskbarIcon_TrayMouseDoubleClick</span><span class="p">);</span>

            <span class="n">AppViewModel</span> <span class="n">avm</span> <span class="p">=</span> <span class="k">new</span> <span class="n">AppViewModel</span><span class="p">();</span>
            <span class="n">taskbarIcon</span><span class="p">.</span><span class="n">ContextMenu</span><span class="p">.</span><span class="n">DataContext</span> <span class="p">=</span> <span class="n">avm</span><span class="p">;</span>
            <span class="n">BaseService</span><span class="p">.</span><span class="n">Restart</span> <span class="p">+=</span> <span class="n">avm</span><span class="p">.</span><span class="n">OnRestart</span><span class="p">;</span>
            <span class="n">BaseService</span><span class="p">.</span><span class="n">CSMessageSync</span> <span class="p">+=</span> <span class="k">new</span> <span class="n">CSMessageSyncHandler</span><span class="p">(</span><span class="n">BaseService_CSMessageSync</span><span class="p">);</span>
            <span class="n">BaseService</span><span class="p">.</span><span class="n">NewUserLogin</span> <span class="p">+=</span> <span class="k">new</span> <span class="n">EventHandler</span><span class="p">(</span><span class="n">BaseService_NewUserLogin</span><span class="p">);</span>

            <span class="cp">#region 监视应用的安装更新</span>
            <span class="k">try</span>
            <span class="p">{</span>
                <span class="k">using</span> <span class="p">(</span><span class="n">RegistryKey</span> <span class="n">rklm</span> <span class="p">=</span> <span class="n">Registry</span><span class="p">.</span><span class="n">LocalMachine</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="k">using</span> <span class="p">(</span><span class="n">RegistryKey</span> <span class="n">rkZqt</span> <span class="p">=</span> <span class="n">rklm</span><span class="p">.</span><span class="n">OpenSubKey</span><span class="p">(</span><span class="n">Constant</span><span class="p">.</span><span class="n">REGISTRYKEY_PRODUCT_ROOT</span> <span class="p">+</span> <span class="n">Constant</span><span class="p">.</span><span class="n">PRODUCT_ID_ZQT</span><span class="p">))</span>
                    <span class="p">{</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">rkZqt</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>
                        <span class="p">{</span>
                            <span class="n">zqtPath</span> <span class="p">=</span> <span class="n">rkZqt</span><span class="p">.</span><span class="n">GetValue</span><span class="p">(</span><span class="n">Constant</span><span class="p">.</span><span class="n">REGISTRYKEY_PRODUCT_SETUPPATH</span><span class="p">,</span> <span class="kt">string</span><span class="p">.</span><span class="n">Empty</span><span class="p">).</span><span class="n">ToString</span><span class="p">();</span>
                        <span class="p">}</span>
                    <span class="p">}</span>
                <span class="p">}</span>
                <span class="n">addInPath</span> <span class="p">=</span> <span class="n">Path</span><span class="p">.</span><span class="n">Combine</span><span class="p">(</span><span class="n">zqtPath</span><span class="p">,</span> <span class="n">Constant</span><span class="p">.</span><span class="n">ADDIN_ROOTPATH</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">catch</span> <span class="p">{</span> <span class="p">}</span>

            <span class="k">if</span> <span class="p">(!</span><span class="kt">string</span><span class="p">.</span><span class="n">IsNullOrEmpty</span><span class="p">(</span><span class="n">addInPath</span><span class="p">.</span><span class="n">Trim</span><span class="p">())</span> <span class="p">&amp;&amp;</span> <span class="n">Directory</span><span class="p">.</span><span class="n">Exists</span><span class="p">(</span><span class="n">addInPath</span><span class="p">))</span>
            <span class="p">{</span>
                <span class="n">FileSystemWatcher</span> <span class="n">watcher</span> <span class="p">=</span> <span class="k">new</span> <span class="n">FileSystemWatcher</span><span class="p">();</span>
                <span class="n">watcher</span><span class="p">.</span><span class="n">Path</span> <span class="p">=</span> <span class="n">addInPath</span><span class="p">;</span>
                <span class="n">watcher</span><span class="p">.</span><span class="n">Filter</span> <span class="p">=</span> <span class="n">Constant</span><span class="p">.</span><span class="n">APPLICATION_MANIFEST</span><span class="p">;</span>
                <span class="n">watcher</span><span class="p">.</span><span class="n">IncludeSubdirectories</span> <span class="p">=</span> <span class="k">true</span><span class="p">;</span>
                <span class="n">watcher</span><span class="p">.</span><span class="n">Created</span> <span class="p">+=</span> <span class="k">new</span> <span class="n">FileSystemEventHandler</span><span class="p">(</span><span class="n">watcher_Created</span><span class="p">);</span>
                <span class="n">watcher</span><span class="p">.</span><span class="n">Changed</span> <span class="p">+=</span> <span class="k">new</span> <span class="n">FileSystemEventHandler</span><span class="p">(</span><span class="n">watcher_Changed</span><span class="p">);</span>
                <span class="n">watcher</span><span class="p">.</span><span class="n">EnableRaisingEvents</span> <span class="p">=</span> <span class="k">true</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="cp">#endregion</span>

            <span class="cp">#region 检查是否有新安装或更新的应用</span>
            <span class="k">try</span>
            <span class="p">{</span>
                <span class="kt">string</span><span class="p">[]</span> <span class="n">menifestFiles</span> <span class="p">=</span> <span class="n">Directory</span><span class="p">.</span><span class="n">GetFiles</span><span class="p">(</span><span class="n">addInPath</span><span class="p">,</span> <span class="n">Constant</span><span class="p">.</span><span class="n">APPLICATION_MANIFEST</span><span class="p">,</span> <span class="n">SearchOption</span><span class="p">.</span><span class="n">AllDirectories</span><span class="p">);</span>
                <span class="k">foreach</span> <span class="p">(</span><span class="kt">string</span> <span class="n">file</span> <span class="k">in</span> <span class="n">menifestFiles</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="n">SetupApp</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">}</span>
            <span class="k">catch</span> <span class="p">{</span> <span class="p">}</span>
            <span class="cp">#endregion</span>

            <span class="cp">#region 启动服务</span>
            <span class="k">try</span>
            <span class="p">{</span>
                <span class="n">host</span> <span class="p">=</span> <span class="k">new</span> <span class="n">ServiceHost</span><span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="n">BaseService</span><span class="p">));</span>
                <span class="n">host</span><span class="p">.</span><span class="n">Open</span><span class="p">();</span>
            <span class="p">}</span>
            <span class="k">catch</span>
            <span class="p">{</span>
                <span class="n">MessageBox</span><span class="p">.</span><span class="n">Show</span><span class="p">(</span><span class="s">&quot;壳牌快速发票系统启动失败&quot;</span><span class="p">,</span> <span class="s">&quot;错误信息&quot;</span><span class="p">,</span> <span class="n">MessageBoxButton</span><span class="p">.</span><span class="n">OK</span><span class="p">,</span> <span class="n">MessageBoxImage</span><span class="p">.</span><span class="n">Error</span><span class="p">);</span>
                <span class="n">Shutdown</span><span class="p">();</span>
            <span class="p">}</span>
            <span class="cp">#endregion</span>

            <span class="cp">#region 启动时的任务</span>
            <span class="n">Thread</span> <span class="n">initialTask</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="p">(()</span> <span class="p">=&gt;</span>
            <span class="p">{</span>
                <span class="k">try</span>
                <span class="p">{</span>
                    <span class="n">PacketManager</span><span class="p">.</span><span class="n">NetworkTest</span><span class="p">();</span>
                <span class="p">}</span>
                <span class="k">catch</span> <span class="p">{</span> <span class="p">}</span>
            <span class="p">});</span>
            <span class="n">initialTask</span><span class="p">.</span><span class="n">Priority</span> <span class="p">=</span> <span class="n">ThreadPriority</span><span class="p">.</span><span class="n">Highest</span><span class="p">;</span>
            <span class="n">initialTask</span><span class="p">.</span><span class="n">IsBackground</span> <span class="p">=</span> <span class="k">true</span><span class="p">;</span>
            <span class="n">initialTask</span><span class="p">.</span><span class="n">Start</span><span class="p">();</span>
            <span class="cp">#endregion</span>

            <span class="cp">#region 同步订阅</span>
            <span class="c1">//newsTimer = new Timer((state) =&gt;</span>
            <span class="c1">//{</span>
            <span class="c1">//    List&lt;Entity.User&gt; loginedUsers = BaseService.LoginedUsers;</span>
            <span class="c1">//    try</span>
            <span class="c1">//    {</span>
            <span class="c1">//        foreach (Entity.User u in loginedUsers)</span>
            <span class="c1">//        {</span>
            <span class="c1">//            InfomationManager.SyncNews(u.UserID);</span>
            <span class="c1">//        }</span>
            <span class="c1">//    }</span>
            <span class="c1">//    catch (Exception ex)</span>
            <span class="c1">//    {</span>
            <span class="c1">//        ExceptionManager.LogException(ex);</span>
            <span class="c1">//    }</span>
            <span class="c1">//}, null, 60000, 300000);</span>
            <span class="cp">#endregion</span>

            <span class="cp">#region 同步公告、通知</span>
            <span class="n">informationTimer</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Timer</span><span class="p">((</span><span class="n">state</span><span class="p">)</span> <span class="p">=&gt;</span>
            <span class="p">{</span>
                <span class="n">List</span><span class="p">&lt;</span><span class="n">Entity</span><span class="p">.</span><span class="n">User</span><span class="p">&gt;</span> <span class="n">loginedUsers</span> <span class="p">=</span> <span class="n">BaseService</span><span class="p">.</span><span class="n">LoginedUsers</span><span class="p">;</span>
                <span class="k">try</span>
                <span class="p">{</span>
                    <span class="k">foreach</span> <span class="p">(</span><span class="n">Entity</span><span class="p">.</span><span class="n">User</span> <span class="n">u</span> <span class="k">in</span> <span class="n">loginedUsers</span><span class="p">)</span>
                    <span class="p">{</span>
                        <span class="n">PacketManager</span><span class="p">.</span><span class="n">SyncInfomation</span><span class="p">(</span><span class="n">BaseService</span><span class="p">.</span><span class="n">QYH</span><span class="p">,</span> <span class="n">u</span><span class="p">.</span><span class="n">UserID</span><span class="p">);</span>
                    <span class="p">}</span>
                <span class="p">}</span>
                <span class="k">catch</span> <span class="p">(</span><span class="n">Exception</span> <span class="n">ex</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="n">ExceptionManager</span><span class="p">.</span><span class="n">LogException</span><span class="p">(</span><span class="n">ex</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">},</span> <span class="k">null</span><span class="p">,</span> <span class="n">Timeout</span><span class="p">.</span><span class="n">Infinite</span><span class="p">,</span> <span class="m">600000</span><span class="p">);</span>
            <span class="cp">#endregion</span>

            <span class="c1">//#region 更新用户信息</span>
            <span class="c1">//updateUserTimer = new Timer((state) =&gt;</span>
            <span class="c1">//{</span>
            <span class="c1">//    List&lt;Entity.User&gt; loginedUsers = BaseService.LoginedUsers;</span>
            <span class="c1">//    try</span>
            <span class="c1">//    {</span>
            <span class="c1">//        foreach (Entity.User u in loginedUsers)</span>
            <span class="c1">//        {</span>
            <span class="c1">//            PacketManager.UploadUsers(BaseService.QYH, u.UserID);</span>
            <span class="c1">//        }</span>
            <span class="c1">//    }</span>
            <span class="c1">//    catch (Exception ex)</span>
            <span class="c1">//    {</span>
            <span class="c1">//        ExceptionManager.LogException(ex);</span>
            <span class="c1">//    }</span>
            <span class="c1">//}, null, 60500, 600000);</span>
            <span class="c1">//#endregion</span>

            <span class="cp">#region 同步客服反馈信息</span>
            <span class="n">csMsgTimer</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Timer</span><span class="p">((</span><span class="n">state</span><span class="p">)</span> <span class="p">=&gt;</span>
            <span class="p">{</span>
                <span class="n">List</span><span class="p">&lt;</span><span class="n">Entity</span><span class="p">.</span><span class="n">User</span><span class="p">&gt;</span> <span class="n">loginedUsers</span> <span class="p">=</span> <span class="n">BaseService</span><span class="p">.</span><span class="n">LoginedUsers</span><span class="p">;</span>
                <span class="k">try</span>
                <span class="p">{</span>
                    <span class="k">foreach</span> <span class="p">(</span><span class="n">Entity</span><span class="p">.</span><span class="n">User</span> <span class="n">u</span> <span class="k">in</span> <span class="n">loginedUsers</span><span class="p">)</span>
                    <span class="p">{</span>
                        <span class="n">PacketManager</span><span class="p">.</span><span class="n">SyncKFFeedback</span><span class="p">(</span><span class="n">u</span><span class="p">.</span><span class="n">UserID</span><span class="p">);</span>
                    <span class="p">}</span>
                <span class="p">}</span>
                <span class="k">catch</span> <span class="p">(</span><span class="n">Exception</span> <span class="n">ex</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="n">ExceptionManager</span><span class="p">.</span><span class="n">LogException</span><span class="p">(</span><span class="n">ex</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">},</span> <span class="k">null</span><span class="p">,</span> <span class="n">Timeout</span><span class="p">.</span><span class="n">Infinite</span><span class="p">,</span> <span class="m">1200000</span><span class="p">);</span>
            <span class="cp">#endregion</span>

            <span class="cp">#region 检查升级服务</span>
            <span class="n">updateServiceCheckTimer</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Timer</span><span class="p">((</span><span class="n">state</span><span class="p">)</span> <span class="p">=&gt;</span>
            <span class="p">{</span>
                <span class="k">try</span>
                <span class="p">{</span>
                    <span class="n">InitFl</span><span class="p">.</span><span class="n">FixService</span><span class="p">.</span><span class="n">ChkServiceSt</span><span class="p">();</span>
                <span class="p">}</span>
                <span class="k">catch</span> <span class="p">(</span><span class="n">Exception</span> <span class="n">ex</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="n">Trace</span><span class="p">.</span><span class="n">TraceError</span><span class="p">(</span><span class="s">&quot;（{0}）：{1}升级服务不能启动：{2}{1}&quot;</span><span class="p">,</span> <span class="n">DateTime</span><span class="p">.</span><span class="n">Now</span><span class="p">,</span> <span class="n">Environment</span><span class="p">.</span><span class="n">NewLine</span><span class="p">,</span> <span class="n">ex</span><span class="p">.</span><span class="n">Message</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">},</span> <span class="k">null</span><span class="p">,</span> <span class="m">60000</span><span class="p">,</span> <span class="m">180000</span><span class="p">);</span>
            <span class="cp">#endregion</span>
        <span class="p">}</span>

        <span class="k">private</span> <span class="k">void</span> <span class="nf">taskbarIcon_TrayMouseDoubleClick</span><span class="p">(</span><span class="kt">object</span> <span class="n">sender</span><span class="p">,</span> <span class="n">RoutedEventArgs</span> <span class="n">e</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">Hashtable</span> <span class="n">regApps</span> <span class="p">=</span> <span class="n">BaseService</span><span class="p">.</span><span class="n">RegApps</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">regApps</span><span class="p">.</span><span class="n">Count</span> <span class="p">&gt;</span> <span class="m">0</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">foreach</span> <span class="p">(</span><span class="n">DictionaryEntry</span> <span class="n">de</span> <span class="k">in</span> <span class="n">regApps</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="n">RegApp</span> <span class="n">ra</span> <span class="p">=</span> <span class="p">(</span><span class="n">RegApp</span><span class="p">)</span><span class="n">de</span><span class="p">.</span><span class="n">Value</span><span class="p">;</span>
                    <span class="kt">int</span> <span class="n">pid</span> <span class="p">=</span> <span class="n">ra</span><span class="p">.</span><span class="n">ProcessId</span><span class="p">;</span>

                    <span class="n">Process</span> <span class="n">process</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span>
                    <span class="k">try</span>
                    <span class="p">{</span>
                        <span class="n">process</span> <span class="p">=</span> <span class="n">Process</span><span class="p">.</span><span class="n">GetProcessById</span><span class="p">(</span><span class="n">pid</span><span class="p">);</span>
                    <span class="p">}</span>
                    <span class="k">catch</span> <span class="p">{</span> <span class="p">}</span>

                    <span class="k">if</span> <span class="p">(</span><span class="n">process</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
                    <span class="p">{</span>
                        <span class="n">BaseService</span><span class="p">.</span><span class="n">RemoveApp</span><span class="p">(</span><span class="n">pid</span><span class="p">);</span>
                        <span class="k">continue</span><span class="p">;</span>
                    <span class="p">}</span>
                    <span class="n">SwitchToThisWindow</span><span class="p">(</span><span class="n">process</span><span class="p">.</span><span class="n">MainWindowHandle</span><span class="p">,</span> <span class="k">true</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="k">return</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="kt">string</span> <span class="n">zqtPath</span> <span class="p">=</span> <span class="kt">string</span><span class="p">.</span><span class="n">Empty</span><span class="p">;</span>
            <span class="k">try</span>
            <span class="p">{</span>
                <span class="k">using</span> <span class="p">(</span><span class="n">RegistryKey</span> <span class="n">rklm</span> <span class="p">=</span> <span class="n">Registry</span><span class="p">.</span><span class="n">LocalMachine</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="k">using</span> <span class="p">(</span><span class="n">RegistryKey</span> <span class="n">rkZqt</span> <span class="p">=</span> <span class="n">rklm</span><span class="p">.</span><span class="n">OpenSubKey</span><span class="p">(</span><span class="n">Constant</span><span class="p">.</span><span class="n">REGISTRYKEY_PRODUCT_ROOT</span> <span class="p">+</span> <span class="n">Constant</span><span class="p">.</span><span class="n">PRODUCT_ID_ZQT</span><span class="p">))</span>
                    <span class="p">{</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">rkZqt</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>
                        <span class="p">{</span>
                            <span class="n">zqtPath</span> <span class="p">=</span> <span class="n">Path</span><span class="p">.</span><span class="n">Combine</span><span class="p">(</span><span class="n">rkZqt</span><span class="p">.</span><span class="n">GetValue</span><span class="p">(</span><span class="n">Constant</span><span class="p">.</span><span class="n">REGISTRYKEY_PRODUCT_SETUPPATH</span><span class="p">,</span> <span class="kt">string</span><span class="p">.</span><span class="n">Empty</span><span class="p">).</span><span class="n">ToString</span><span class="p">(),</span> <span class="n">Constant</span><span class="p">.</span><span class="n">EXE_NAME_ZQT</span><span class="p">);</span>
                        <span class="p">}</span>
                    <span class="p">}</span>
                <span class="p">}</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">zqtPath</span><span class="p">.</span><span class="n">Length</span> <span class="p">&gt;</span> <span class="m">0</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="n">Process</span><span class="p">.</span><span class="n">Start</span><span class="p">(</span><span class="n">zqtPath</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">}</span>
            <span class="k">catch</span> <span class="p">{</span> <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">private</span> <span class="k">void</span> <span class="nf">Application_Exit</span><span class="p">(</span><span class="kt">object</span> <span class="n">sender</span><span class="p">,</span> <span class="n">ExitEventArgs</span> <span class="n">e</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">try</span>
            <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">host</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="n">host</span><span class="p">.</span><span class="n">Close</span><span class="p">();</span>
                <span class="p">}</span>

                <span class="k">if</span> <span class="p">(</span><span class="n">informationTimer</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="n">informationTimer</span><span class="p">.</span><span class="n">Dispose</span><span class="p">();</span>
                <span class="p">}</span>

                <span class="k">if</span> <span class="p">(</span><span class="n">newsTimer</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="n">newsTimer</span><span class="p">.</span><span class="n">Dispose</span><span class="p">();</span>
                <span class="p">}</span>

                <span class="c1">//if (updateUserTimer != null)</span>
                <span class="c1">//{</span>
                <span class="c1">//    updateUserTimer.Dispose();</span>
                <span class="c1">//}</span>

                <span class="k">if</span> <span class="p">(</span><span class="n">csMsgTimer</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="n">csMsgTimer</span><span class="p">.</span><span class="n">Dispose</span><span class="p">();</span>
                <span class="p">}</span>

                <span class="k">if</span> <span class="p">(</span><span class="n">updateServiceCheckTimer</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="n">updateServiceCheckTimer</span><span class="p">.</span><span class="n">Dispose</span><span class="p">();</span>
                <span class="p">}</span>
            <span class="p">}</span>
            <span class="k">catch</span> <span class="p">{</span> <span class="p">}</span>
            <span class="n">taskbarIcon</span><span class="p">.</span><span class="n">Dispose</span><span class="p">();</span>
        <span class="p">}</span>

        <span class="k">private</span> <span class="k">void</span> <span class="nf">App_UnhandleException</span><span class="p">(</span><span class="kt">object</span> <span class="n">sender</span><span class="p">,</span> <span class="n">System</span><span class="p">.</span><span class="n">Windows</span><span class="p">.</span><span class="n">Threading</span><span class="p">.</span><span class="n">DispatcherUnhandledExceptionEventArgs</span> <span class="n">e</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">StringBuilder</span> <span class="n">error</span> <span class="p">=</span> <span class="k">new</span> <span class="n">StringBuilder</span><span class="p">();</span>
            <span class="n">ExceptionManager</span><span class="p">.</span><span class="n">FormatException</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">Exception</span><span class="p">,</span> <span class="n">error</span><span class="p">);</span>

            <span class="kt">string</span> <span class="n">errMsg</span> <span class="p">=</span> <span class="n">e</span><span class="p">.</span><span class="n">Exception</span><span class="p">.</span><span class="n">Message</span><span class="p">;</span>
            <span class="n">ExceptionForm</span> <span class="n">ef</span> <span class="p">=</span> <span class="k">new</span> <span class="n">ExceptionForm</span><span class="p">(</span><span class="n">errMsg</span><span class="p">,</span> <span class="n">error</span><span class="p">.</span><span class="n">ToString</span><span class="p">());</span>
            <span class="n">ef</span><span class="p">.</span><span class="n">ShowDialog</span><span class="p">();</span>

            <span class="n">ExceptionManager</span><span class="p">.</span><span class="n">LogException</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">Exception</span><span class="p">);</span>
            <span class="n">e</span><span class="p">.</span><span class="n">Handled</span> <span class="p">=</span> <span class="k">true</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="cp">#endregion</span>

        <span class="cp">#region Win32 API</span>
<span class="na">        [DllImport(&quot;User32.dll&quot;)]</span>
        <span class="k">private</span> <span class="k">static</span> <span class="k">extern</span> <span class="kt">byte</span> <span class="nf">SetForegroundWindow</span><span class="p">(</span><span class="n">IntPtr</span> <span class="n">hwnd</span><span class="p">);</span>

<span class="na">        [DllImport(&quot;User32.dll&quot;)]</span>
        <span class="k">private</span> <span class="k">static</span> <span class="k">extern</span> <span class="kt">bool</span> <span class="nf">SwitchToThisWindow</span><span class="p">(</span><span class="n">IntPtr</span> <span class="n">hwnd</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">fAltTab</span><span class="p">);</span>
        <span class="cp">#endregion</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></div>

<br/>
<div style="margin-top:10px;margin-bottom:10px">
  
  <span class="next">
    上篇：
    <a href="/wpf/2014/09/22/ddd.html">
      你好，世界
    </a>
  </span>
   
  
  <span class="prev">
    下篇：
    <a href="/pmp/2014/09/24/zlyici.html">
      哈哈
    </a>
  </span>
  
</div>
<hr>
<div class="ds-thread" data-thread-key="/wpf/2014/09/22/hello-world.html" data-title="你好，世界" data-url="/wpf/2014/09/22/hello-world.html"></div>
<script type="text/javascript">
var duoshuoQuery = {short_name:"liuzs"};
	(function() {
		var ds = document.createElement('script');
		ds.type = 'text/javascript';ds.async = true;
		ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
		ds.charset = 'UTF-8';
		(document.getElementsByTagName('head')[0] 
		 || document.getElementsByTagName('body')[0]).appendChild(ds);
	})();
</script>
        </div>
        <!-- Blog Sidebar Widgets Column -->
        <div class="col-md-4">
          <!-- Blog Search Well -->
          <div class="well">
            <h4>
              站内搜索
            </h4>
            <form action="https://www.google.com/search" method="get">
              <div class="input-group">
                <input type="text" name="q" class="form-control">
				<input type="hidden" name="ie" value="UTF-8" />
				<input type="hidden" name="sitesearch" value="" />
                <span class="input-group-btn">
                  <button class="btn btn-default" type="submit">
                    <span class="glyphicon glyphicon-search">
                    </span>
                  </button>
                </span>
              </div>
            </form>
            <!-- /.input-group -->
          </div>
          <!-- Blog Categories Well -->
          <div class="well">
            <h4>
              分 类
            </h4>
            <div class="row">
              <div class="col-lg-6">
                <ul class="list-unstyled">
                  <li>
                    <a href="/categories/pmp/">PMP</a>
                  </li>
                </ul>
              </div>
              <!-- /.col-lg-6 -->
            </div>
            <!-- /.row -->
          </div>
          <!-- Blog Links Well -->
          <div class="well">
            <h4>
              相关链接
            </h4>
            <ul class="list-unstyled">
              <li>
                <a href="https://github.com/liuzhisheng">
                  GitHub
                </a>
              </li>
              <li>
                <a href="http://weibo.com/zhishengliu">
                  新浪微博
                </a>
              </li>
            </ul>
          </div>
        </div>
      </div>
      <!-- /.row -->
      <hr>
      <!-- Footer -->
      <footer>
        <div class="row">
          <div class="col-lg-12">
            <p align="center">
              Copyright &copy;  2014, hosted on <a href="https://github.com/liuzhisheng">GitHub</a>, built with Jekyll. <a href="https://github.com/liuzhisheng/liuzhisheng.github.io/">[source]</a>
            </p>
          </div>
          <!-- /.col-lg-12 -->
        </div>
        <!-- /.row -->
      </footer>
    </div>
    <!-- /.container -->
    <!-- jQuery Version 1.11.0 -->
    <script src="js/jquery-1.11.0.js"></script>
    <!-- Bootstrap Core JavaScript -->
    <script src="js/bootstrap.min.js"></script>
  </body>
</html>
